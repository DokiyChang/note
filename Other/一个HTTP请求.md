# 一个HTTP请求都做了什么？

> "Without the container, there would be no globalization.", *The Economist*	

## 引言

信息都以二进制数据传输，协议是对二进制数据的**约定**

各种协议通过其约定好的格式，从一台设备传输到另一台设备，接收设备根据约定的格式来获取传递的信息。

各层模型各司其职，封装之后交由下一层处理

网络模型中各层架构都只处理部分功能，每层的数据的实际传输都会交由下一层模型处理，直到传递到物理层。也就是说数据在`网络层`传输时，会被网络层协议封成协议对应格式的`数据包`，然后将该数据包再在外层封装成链路层所对应的`数据帧`，最后再交由`数据链路层`处理，且对数据链路层`来说网络层传输的数据包内容是透明的，数据链路层只关心封装的数据帧中的数据。



网上对网络模型的说法众说纷纭，主要是OSI七层模型和TCP/IP五层模型：

![网络模型](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/705728-20160424234826351-1957282396.png)

随着技术的发展，对于七层模型中的表示层和会话层基本都在应用层实现了，所以有了后来的五层模型。但如今很多业务需要对应用层与传输层之间做特定的连接，于是在后端衍生出很多Socket编程，来弥补表示层和会话层中的部分功能。

本文将模拟向谷歌发送一个HTTP请求，通过TCP/IP五层模型来简单讲解计算机网络中数据的传输过程，以及计算机网络的发展历史，而所有的所有都要从连接开始。

## 连接

### 物理层

正如引言中所说，所以到数据传输最后都必然通过物理信道传递。想要发送一个HTTP请求并得到数据，就首先需要建立物理连接。物理层中的通信方式可以是各种各样的，只要能够将信号和二进制数据进行转换即可。比如电缆，光缆。

当物理层成功连接时，对于之后的传输就只需要将数据转换成对于的二进制数据即可。



这个时候每个需要访问谷歌的用户，只需要将自己的网线连接到谷歌服务器上，理论上就可以发送请求获取谷歌首页数据了。根据李彦宏的10亿谷歌用户的说法，谷歌只需要准备10亿的物理接口即可。拓扑图大概长这样：

![QQ20201113-0](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/QQ20201113-0.jpeg)



### 数据链路层

10亿个接口确实稍微多了一点。但对于最原始的有线网络，多台计算机之间的连接都是通过网线直接连接。如果计算机数量增多，且需要互相传递数据时，就需要无数根网线在每两台计算机之间进行连接。

于是后来出现了`交换机`，用于连接所有连接在该交换机下的设备（以太网）。且后来出现了核心交换机，可以将交换机连接起来，这样就可以吧多个交换机连接的网络连接起来通信。（局域网）

但是问题来了，如何确定我要发送的数据会被准确的发送到的某台设备？

`网卡`即解决了这一问题。网卡在生产的时候会有一个全球唯一的`MAC地址`。这个时候，多台计算机连接在交换机上时，需要先将自己的MAC地址告诉给交换机。所有的数据传输会先被封装到保存有目标MAC地址和源MAC地址的数据帧里，由交换机分配。

![数据帧格式](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/u=459692903,458309401&fm=26&gp=0.jpg)

这里需要留意一下帧中数据部分的大小。也就是说一个数据帧最多能传输的数据只有1518个字节，且实际传输数据只有1500字节。

这个时候多个以太网可以共用一个信道与谷歌的服务器进行连接。但是，由于物理层只负责数据，只要接收到有数据就会传输，所以两个数据帧同时传输时就会产生冲突（当然会有相应的协议来解决冲突产生时应当如何处理，比如`CSMA/CD`载波监听多路访问），这也是为什么早期的拨号上网多以时间计费的原因。



现在我们可以不用自己拖一根网线与谷歌的服务器连接通信了，只需要在跟谷歌通信时交纳巨额的网费来完成信道的租用。现在拓扑图大概长这样：

![QQ20201113-1](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/QQ20201113-1.jpeg)



### 网络层

但是如果现在想访问搜狗，所有的交换机还需要跟搜狗的服务器连接。且更严重的是某台交换机宕机了其下的6000多台终端都无法与谷歌连接。

如何才能让每台设备都能独立访问到谷歌服务器？

为了让“自己的计算机网络在受到袭击时，即使部分网络被摧毁，其余部分仍能保持通信联系”美国国防部的高级研究计划局（ARPA）建设了一个军用网，叫做“阿帕网”（ARPAnet）。大概长这样：

![QQ20201113-5](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/QQ20201113-5.jpg)

在此基础上，1974年，罗伯特·卡恩和文顿·瑟夫提出[TCP/IP](https://zh.wikipedia.org/wiki/TCP/IP)来解决数据传输（IP）与传输控制（TCP）问题。IP协议约定连接的每台主机都保存有一个全球唯一的`IP地址`，在连接其他设备时会交换该地址，并保存，传输数据时通过统一的`IP数据包`传输。IP数据包大概长这样：

![QQ20201113-0](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/QQ20201113-0.png)

这样所有在遵循该协议约定下连接到主机都可以连接到任意一台其他主机。并且每台设备并不需要知道到达目的地址的路径，只需要知道将数据包给谁即可。

比如下图，A并不需要知道将数据包发给D需要经过B，C。只需要知道需要将该数据包发给B即可，因为B也知道将数据包发给D只需要把数据包发给C即可。

![路由](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/QQ20201113-2.jpeg)

`网关`和`子网掩码`就是用于实现这一解决方案的。网关会通过子网掩码和目标地址来确定`网络号`

![子网掩码](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/1-1Z314102225202.png)

然后在自己已知的`路由`中查找网段对应的下一台设备，然后将该数据包发送给该设备，由该设备进行下一步的传递。



这里IP协议只解决了数据的传输问题，而诸如传输数据产生冲突等一系列问题已经有数链路层解决，所有只需要将`数据包`封装为`数据帧`中的数据部分，即可不用考虑这些问题。

![封装帧](/Users/atyun/Documents/typora/note/image/Other/一个HTTP请求/a11c4e32ffbc92889fcb30560a8fda6.jpg)

同时根据数据包格式可以看到，头部最少固定占有20字节的数据，而要将数据包封装到数据帧中，其最多能装载的数据大小就只有1480字节。

对于较大数据的传输，IP协议也允许对传输内容分片，且每个分片所在的数据包可能通过不同的路由到达目标地址。然后目标主机通过头部总长度、标识、片偏移等信息将收到的数据包重新组合得到传输的数据。



于是所有这些连接的设备一起形成了今天我们所说的互联网（Internet，也叫因特网，谢希仁在《计算机网络（第七版）》中改称互联网）至此我们解决了如何跟谷歌连接的所有问题。接下来就是考虑当在浏览器地址栏输入"www.google.com"时，如何让谷歌返回页面。



## 通信

正如引言提到的“各层模型各司其职”，我们不用再考虑数据在网络中的传输。而对于Web开发来说，一切才刚刚开始。



### 应用层

如今只需要跟谷歌约定好，当我们发送''www.google.com"时，需要给我返回的是首页的信息。而约定的具体内容就是HTTP协议。

